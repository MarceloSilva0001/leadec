<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Renomeador de PDFs - LEADEC</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f8f9fa; }
    .container { max-width: 600px; margin: 0 auto; background: #fff; border-radius: 10px; padding: 32px; box-shadow: 0 0 30px #0002;}
    .progress-bar { height: 22px; background: #e9ecef; border-radius: 8px; margin-bottom: 12px; overflow: hidden;}
    .progress { height: 100%; background: #2d90f5; width: 0; transition: width 0.2s;}
    .status { margin-bottom: 10px; font-size: 1.1em; color: #2d90f5;}
    .error { color: #c00; font-weight: bold; }
    .success { color: #090; font-weight: bold;}
    input[type="file"] { padding: 10px;}
    button { margin-top: 20px; padding: 10px 30px; border: none; border-radius: 6px; background: #2d90f5; color: #fff; font-size: 1.1em; cursor: pointer;}
    button:disabled { background: #999; cursor: not-allowed; }
    ul { font-size: 0.97em; color: #333; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Renomeador de PDFs - LEADEC</h2>
    <p>Faça upload de vários espelhos de ponto em PDF.<br>
    O sistema extrai automaticamente o <b>nome do colaborador</b> e renomeia o arquivo.</p>
    <input type="file" id="fileInput" accept="application/pdf" multiple><br>
    <div class="progress-bar"><div class="progress" id="progress"></div></div>
    <div class="status" id="status">Aguardando arquivos...</div>
    <ul id="log"></ul>
    <button id="downloadBtn" style="display:none">Baixar PDFs renomeados (.zip)</button>
  </div>

<script>
const fileInput = document.getElementById('fileInput');
const status = document.getElementById('status');
const progress = document.getElementById('progress');
const log = document.getElementById('log');
const downloadBtn = document.getElementById('downloadBtn');

let renamedFiles = [];

function sanitizeFileName(name) {
  return name.replace(/[\\/:*?"<>|]+/g, '').replace(/\s+/g, ' ').trim();
}

function findColaboradorName(text) {
  // Divide o texto em linhas
  const lines = text.split('\n').map(line => line.trim());
  
  // Procura pela linha "Nome" e verifica a linha anterior
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].toUpperCase().includes('NOME') && i > 0) {
      const nomeLine = lines[i-1].trim();
      // Verifica se a linha anterior parece um nome (pelo menos 2 palavras com maiúsculas)
      if (nomeLine === nomeLine.toUpperCase() && 
          nomeLine.split(' ').length >= 2 && 
          nomeLine.split(' ').every(word => word.length > 2)) {
        return nomeLine;
      }
    }
  }
  
  // Caso não encontre, procura por padrões de nome em maiúsculas
  const namePattern = /^([A-ZÀ-Ú]{3,}(?:\s+[A-ZÀ-Ú]{3,})+)$/;
  for (let i = 0; i < lines.length; i++) {
    const match = lines[i].match(namePattern);
    if (match && match[1]) {
      return match[1].trim();
    }
  }
  
  return null;
}

async function processFiles(files) {
  renamedFiles = [];
  log.innerHTML = '';
  let zip = new JSZip();
  let nameCounts = {};
  let errors = 0;

  for (let i = 0; i < files.length; i++) {
    status.innerHTML = `Processando arquivo ${i+1}/${files.length}...`;
    progress.style.width = `${((i+1)/files.length)*100}%`;

    const file = files[i];
    let arrayBuffer;
    try {
      arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      let fullText = "";
      
      // Processa apenas a primeira página (onde normalmente está o nome)
      const page = await pdf.getPage(1);
      const content = await page.getTextContent();
      fullText = content.items.map(i => i.str).join('\n');

      const nome = findColaboradorName(fullText);

      if (!nome) {
        log.innerHTML += `<li class="error">[${file.name}] <b>Nome não identificado!</b></li>`;
        errors++;
        continue;
      }

      let safeName = sanitizeFileName(nome);
      if (nameCounts[safeName]) {
        nameCounts[safeName]++;
        safeName += ` (${nameCounts[safeName]})`;
      } else {
        nameCounts[safeName] = 1;
      }

      const newFileName = safeName + '.pdf';
      zip.file(newFileName, arrayBuffer);
      renamedFiles.push(newFileName);

      log.innerHTML += `<li class="success">[${file.name}] &rarr; <b>${newFileName}</b></li>`;

    } catch (err) {
      log.innerHTML += `<li class="error">[${file.name}] Erro ao processar: ${err.message}</li>`;
      errors++;
    }
  }

  progress.style.width = `100%`;
  if (renamedFiles.length > 0) {
    status.innerHTML = `<b>Concluído!</b> (${renamedFiles.length} arquivos prontos${errors ? ', ' + errors + ' com erro' : ''})`;
    downloadBtn.style.display = 'inline-block';
    downloadBtn.onclick = async function() {
      status.innerHTML = 'Gerando ZIP...';
      const blob = await zip.generateAsync({type:'blob'});
      saveAs(blob, 'pdfs_renomeados.zip');
      status.innerHTML = `<b>Concluído!</b> Download liberado.`;
    };
  } else {
    status.innerHTML = `<span class="error">Nenhum arquivo processado corretamente!</span>`;
    downloadBtn.style.display = 'none';
  }
}

fileInput.addEventListener('change', (e) => {
  const files = Array.from(e.target.files).filter(f => f.type === 'application/pdf');
  if (!files.length) {
    status.innerHTML = '<span class="error">Selecione ao menos um arquivo PDF válido!</span>';
    return;
  }
  status.innerHTML = `Iniciando processamento de ${files.length} arquivos...`;
  downloadBtn.style.display = 'none';
  processFiles(files);
});
</script>
</body>
</html>